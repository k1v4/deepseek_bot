# Deepseek Bot

Для запуска бота необходимо
- Создать файл окружения .env со указанием следующих переменных:
  - BOT_TOKEN=
  - DEEPSEEK_API_KEY=
  - DEEPSEEK_ENDPOINT=
  - MODEL=
  - TEMPERATURE=
  - MAX_TOKENS=

# Отчет о разработке Telegram-бота с интеграцией AI (DeepSeek)

**Тема:** Разработка интеллектуального чат-бота ассистента с функциями AI-агента и информационными сервисами.  
**Выполнили:** Гендлер Семен, Иванчин Кирилл, Истомин Александр РИС-22-2

## 1. Постановка задачи

Целью работы являлась разработка многофункционального чат-бота для мессенджера Telegram, который сочетает в себе:
1.  **AI-агента:** Возможность вести диалог на естественном языке, отвечать на вопросы и помогать в решении задач, используя LLM (Large Language Model) DeepSeek.
2.  **Информационные сервисы:** Предоставление актуальных данных по запросу пользователя через интерактивное меню (курс валют, текущее время).
3.  **Развлекательный контент:** Генерация шуток.

Бот реализован на языке Python, поддерживает асинхронную работу и упакован в Docker-контейнер для удобства развертывания.

## 2. Используемые инструменты и технологии

В ходе разработки использовался следующий стек технологий:

*   **Язык программирования:** Python 3.12.
*   **Фреймворк для Telegram:** `aiogram 3.x` - современная асинхронная библиотека для взаимодействия с Telegram Bot API.
*   **Искусственный интеллект:** API `DeepSeek` (через клиентскую библиотеку `openai`).
*   **Сетевые запросы:** `aiohttp` - для асинхронных HTTP-запросов к сторонним API (курсы валют, шутки).
*   **Контейнеризация:** `Docker` и `Docker Compose` для изоляции окружения и запуска.
*   **Форматирование:** `telegramify-markdown` - для корректного отображения Markdown-разметки от нейросети в сообщениях Telegram.

## 3. Архитектура и алгоритм работы

Проект построен по модульному принципу, что облегчает поддержку и расширение функционала.

### Структура проекта:
*   `main.py` - точка входа, инициализация бота и диспетчера.
*   `handlers.py` - обработчики сообщений и callback-запросов (логика маршрутизации).
*   `bot/api/` - модули для взаимодействия с внешними сервисами (`deepseek.py`, `currency.py`, `joke.py`).
*   `settings.py` - управление конфигурацией и переменными окружения.

### Алгоритм обработки запросов:

1.  **Команда `/start`:**
    *   Бот приветствует пользователя и отправляет Inline-клавиатуру с кнопками быстрого доступа: "Курс валют", "Случайная шутка", "Текущее время".

2.  **Обработка кнопок (Callback Query):**
    *   **Курс валют:** Бот делает запрос к `exchangerate-api.com`. Получает базовый курс USD, затем математически рассчитывает кросс-курсы для EUR и GBP по отношению к рублю.
    *   **Шутка:** Делается запрос к `official-joke-api`. В случае ошибки или недоступности API предусмотрен запасной вариант - запрос к другому API или выдача локально заготовленных шуток.
    *   **Время:** Определяется серверное время, форматируется под московский часовой пояс и отправляется пользователю.

3.  **Обработка текстовых сообщений (AI-агент):**
    *   Если сообщение не является командой и отправлено в ЛС (или содержит ключевое слово в группе), оно передается в модуль `deepseek.py`.
    *   Бот отправляет статус "печатает" (`ChatAction.TYPING`) для индикации работы.
    *   Запрос отправляется в DeepSeek API.
    *   Полученный ответ обрабатывается библиотекой `telegramify-markdown` для конвертации в валидный Telegram Markdown V2.
    *   Ответ отправляется пользователю.

## 4. Возникшие трудности и их решение

В процессе разработки были выявлены и решены следующие проблемы:

1.  **Доступ к API валют (Геоблокировка):**
    *   *Проблема:* Выбранный API провайдер (`exchangerate-api.com`) и некоторые альтернативные сервисы могут блокировать запросы с российских IP-адресов или работать нестабильно.
    *   *Решение:* При развертывании бота необходимо использовать хостинг за пределами РФ или настроить VPN-туннелирование на уровне хост-машины/контейнера. В коде также добавлена обработка ошибок (`try-except`), чтобы бот не падал при таймауте соединения.

2.  **Форматирование Markdown:**
    *   *Проблема:* Нейросети часто возвращают текст с символами Markdown (звездочки, решетки), которые Telegram требует экранировать в режиме `MarkdownV2`. Если пропустить хоть один символ, API Telegram возвращает ошибку 400, и сообщение не доставляется.
    *   *Решение:* Использована библиотека `telegramify-markdown` в связке с кастомной функцией `escape_markdown`, которая через регулярные выражения экранирует служебные символы.

3.  **Асинхронность и блокировки:**
    *   *Проблема:* Долгие запросы к нейросети могли бы блокировать работу бота для других пользователей.
    *   *Решение:* Весь ввод-вывод реализован асинхронно с использованием `asyncio` и `aiohttp`.

## 5. Исходный код

Ниже приведена ссылка на GitHub репозиторий реализованного бота.  
https://github.com/k1v4/deepseek_bot


## 6. Выводы

В результате выполнения работы был создан полнофункциональный Telegram-бот, соответствующий критериям оценки на 9-10 баллов (реализован AI-агент). Бот успешно определяет интент пользователя: если это команда меню - выполняется четкий алгоритм, если произвольный текст - подключается нейросеть DeepSeek. Приложение готово к развертыванию через Docker, что обеспечивает его переносимость и стабильность.